
# Provides the '%test_no_runtime_execution' LLVM-lit command.
# This uses LLC and patmos-ld to compile the LLVM-IR test program without any 
# standard library or runtime code of any kind, producing a standalone ELF that 
# is then run on pasim.
# 
# The program must have a 'main' function defined where execution starts
# and that returns 'i32'.
# For correct execution, the program must return 0. Any other return value
# is treated as an error and the test will fail.
# The program has 400 cycles to execute before it is stopped and assumed a failure.
# Note that it takes around 100 cycles to reach the 'main' function,
# giving it less than 300 cycles to run. Therefore, the aim should be that the
# 'main' function finishes within 200 cycles.

# Complete path to _start function
_start_file=os.path.dirname(__file__) + "/_start.ll"

# Make sure the _start function file doesn't get treated as a test
config.excludes.add("_start.ll")

# setup substitution for %test_no_runtime_execution.
config.substitutions.append(('%test_no_runtime_execution',
	# Compile program
	"llc %s -filetype=obj -o %t && \\\n" +
	# Compile startup function
	"llc " + _start_file + " -filetype=obj -o %t_start.o && \\\n" +
	# Link program and startup function and emit ELF
	"patmos-ld  -nostdlib -static -o %t %t %t_start.o && \\\n" +
	# Run program
	"pasim %t -c 400"
))